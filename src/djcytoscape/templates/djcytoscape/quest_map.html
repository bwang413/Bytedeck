{% extends "djcytoscape/base.html" %}
{% load static %}
{% block head_css %}
{% block head %}
  <link rel="stylesheet" href="{% static 'djcytoscape/css/djcytoscape.css' %}">
{% endblock %}
{% endblock %}
{% block heading_inner %}{{ scape.name }} Quest Map
{% if personalized_user %}
    <br><small>of <a href="{% url 'profiles:profile_detail' personalized_user.profile.id %}">{{personalized_user}}</a>, {{ personalized_user.profile}}</small>
{%endif %}
{% endblock%}
{% block content %}
    {% if user.is_staff %}
        <p>
            <a class="btn btn-primary" href="{% url 'djcytoscape:regenerate_all' %}" role="button"
              title = "Recalculate ALL Maps.  This may take a few moments." >
              <i class="fa fa-refresh"></i>
            </a>
            <a class="btn btn-success" href="{% url 'djcytoscape:regenerate' scape.id %}" role="button"
              title = "Recalculate this Map." >
              <i class="fa fa-undo"></i>
            </a>
            <a class="btn btn-default" href="{% url 'djcytoscape:list' %}" role="button"
              title = "List all maps" >
              <i class="fa fa-list-ul"></i>
            </a>
            <a class="btn btn-warning" href="{% url 'djcytoscape:update' scape.id %}" role="button"
              title = "Edit the Map" >
              <i class="fa fa-edit"></i>
            </a>
            <a class="btn btn-danger" href="{% url 'djcytoscape:delete' scape.id %}" role="button"
              title = "Delete this Map" >
              <i class="fa fa-trash-o"></i>
            </a>
        &nbsp;&nbsp;&nbsp;Generated on {{ scape.last_regeneration }}
        </p>

    {%  endif %}

    <p id="fullscreen" class="pull-right">
      <a id="btn-print" role="button" class="btn btn-default">Print <i class="fa fa-print"></i></a>
      <a id="btn-fullscreen" role="button" class="btn btn-default">Fullscreen <i class="fa fa-arrows-alt"></i></a>
    </p>

    <p>Click on a quest to go to it.  A blue quest or badge will take you to a connected map.
      Some quests are available based on your Rank; see the <a href="{% url 'courses:ranks' %}">Ranks page</a>
      to view the Rank-based maps.</p>



    {% if scape.parent_scape %}
        <p>Back to <a href="{{ scape.parent_scape.get_absolute_url }}">{{ scape.parent_scape }} Quest Map</a></p>
    {% endif %}
    <div id="cy"></div>

{% endblock %}
{% block js %}
<script>
    window.jQuery || document.write('<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="crossorigin="anonymous"><\/script>')
</script>
<script src="{% static 'djcytoscape/js/cytoscape.min.js' %}"></script>
<script src="{% static 'djcytoscape/js/dagre.min.js' %}"></script>
<script src="{% static 'djcytoscape/js/cytoscape-dagre.js' %}"></script>

<script>
    var cy = cytoscape({{ cytoscape_json|safe }})

    // redirect to linked quest map
    cy.on('tap', '[href]', function(){
        window.location.href = this.data('href');
    });



    // scape.style_set
    {{ scape.style_set.javascript|safe }}

    // completed quests
    cy.ready( function(event) {
        {% for id in completed_quests %}
        cy.nodes('[Quest = {{id}}]').addClass('completed');
        {% endfor %}
    });


    cy.on('mouseover', '[href]', function(){
        $('#cy').css('cursor', 'pointer');
        this.addClass('link_hover')
    });
    cy.on('mouseout', '[href]', function(){
        $('#cy').css('cursor', 'move');
        this.removeClass('link_hover')
    });

    // nodes that don't link
    cy.on('mouseover', '[^href]', function(){
        $('#cy').css('cursor', 'default');
    });
    cy.on('mouseout', '[^href]', function(){
        $('#cy').css('cursor', 'move');
    });


    cy.on('ready', function () {
        updateBounds();
    });


    $(document).ready(function() { 
      updateBounds();
      //if they resize the window, resize the diagram
      $(window).resize(function () {
        updateBounds();
      });
        cy.center();
        cy.resize();


    }); // dom ready

    var updateBounds = function () {
        var bounds = cy.elements().boundingBox();
        $('#cy').css('height', bounds.h + 50);
        cy.center();
        cy.resize();
    };

</script>

<script src="{% static 'djcytoscape/js/maps.js' %}"></script>

{% if request.user.profile.dark_theme %}
 <script src="{% static 'djcytoscape/js/maps-dark.js' %}"></script>
{% endif %}

{% endblock %}
