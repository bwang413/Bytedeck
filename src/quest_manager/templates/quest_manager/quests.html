<!--
  QUESTS
    > available (tab_quests_available.html)
    > in progress (tab_quests_submission.html)
    > completed (tab_quests_submission.html)
    > past courses (tab_quests_submission.html)
-->

{% extends "quest_manager/base.html" %}
{% load crispy_forms_tags %}

{% block heading_inner %} {{ heading }}
  {% if request.user.is_staff %}
    <a class="btn btn-primary" href="{% url 'quests:quest_create' %}" role="button">New</a>
  {% endif %}
{% endblock %}

{% block content %}

<ul id='quest-tabs' class="nav nav-tabs nav-justified" role="tablist">
  <li role="presentation" {% if available_tab_active %}class="active"{% endif%}>
    <a href="{% url 'quests:available' %}">
      Available
      <span class="badge">{{num_available}}</span>
    </a>

  </li>
  <li role="presentation" {% if inprogress_tab_active %}class="active"{% endif%}>
    <a href="{% url 'quests:inprogress' %}">
      In Progress
      <span class="badge">{{num_inprogress}}</span>
    </a>
  </li>
  <li role="presentation" {% if completed_tab_active %}class="active"{% endif%}>
    <a href="{% url 'quests:completed' %}">
      Completed
      <span class="badge">{{num_completed}}</span>
    </a>
  </li>
  {% if request.user.profile.has_past_courses %}
  <li role="presentation" {% if past_tab_active %}class="active"{% endif%}>
    <a href="{% url 'quests:past' %}">
      Past Courses
      <span class="badge">{{num_completed}}</span>
    </a>
  </li>
  {% endif %}
</ul>
<!-- Tab panes -->
<div class="tab-content">
  <div role="tabpanel"
  class="tab-pane fade {% if available_tab_active %}in active{% endif%}" id="available">
    {% if request.user.profile.has_current_course %}
      {% include 'quest_manager/tab_quests_available.html' %}
    {% else %}
      <p>
        You have not joined a course yet for this semester.</p>
        <a href="{% url 'courses:create' %}" class="btn btn-info" role="button">Join a Course</a>

    {% endif %}
  </div>
  <div role="tabpanel"
  class="tab-pane fade {% if inprogress_tab_active %}in active{% endif%}" id="inprogress">
    {% with submissions=in_progress_submissions %}
      {% include 'quest_manager/tab_quests_submission.html' %}
    {% endwith %}
  </div>
  <div role="tabpanel"
  class="tab-pane fade {% if completed_tab_active %}in active{% endif%}" id="completed">
    {% with submissions=completed_submissions completed=True %}
      {% include 'quest_manager/tab_quests_submission.html' %}
    {% endwith %}
  </div>
  {% if request.user.profile.has_past_courses %}
  <div role="tabpanel"
  class="tab-pane fade {% if past_tab_active %}in active{% endif%}" id="completed">
    {% with submissions=past_submissions past=True %}
      {% include 'quest_manager/tab_quests_submission.html' %}
    {% endwith %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
  // this method contain your ajax request
  function ajaxQuestInfo(id) {
    //Update hidden quest detail content that is displayed upon expansion
    var ajax_url = "{% url 'quests:ajax_quest_root' %}" + id + "/";
    var preview_content_selector = "#preview-content-" + id;

    //console.log(preview_class)
    $.ajax({
      type: "POST",
      url: ajax_url,
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      },
      success: function(data){
        $(preview_content_selector).html(data);
      }
    });

    //console.log("ajaxLoadQuestDetails...Loading Quest: " + quest_id)
  }

  $(document).ready(function() {

      // cycle through each quest/submission and add content to accordian panel
      $(".accordian-trigger").each(function( index ) {

        // get the quest/submission id from the id of the accordian panel
        var html_id = $(this).attr('id')
        // http://stackoverflow.com/questions/6340180/regex-to-get-the-number-from-the-end-of-a-string
        // quest/sub id is number at end of html_id
        var id = parseInt(html_id.match(/\d+$/)[0], 10);

        var is_submission = true; //in progress tab by default
        var is_completed = false;
        var is_past = false;

        // if this is the available tab, then it will list quests, not submissions
        // if submissions, need to determing which tab
        if(window.location.href.indexOf("/available/") > -1) {
          is_submission = false;
        }
        else if(window.location.href.indexOf("/completed/") > -1) {
          is_completed = true;
        }
        else if(window.location.href.indexOf("/past/") > -1) {
          is_past = true;
        }

        // get ajax url based on tab
        if(!is_submission) { // available quests
          var ajax_url = "{% url 'quests:ajax_quest_root' %}" + id + "/";
        }
        else if(is_completed){
          var ajax_url = "{% url 'quests:ajax_submission_root' %}" + id + "/completed/";
        }
        else if(is_past){
          var ajax_url = "{% url 'quests:ajax_submission_root' %}" + id + "/past/";
        }
        else {
          var ajax_url = "{% url 'quests:ajax_submission_root' %}" + id + "/";
        }

        var preview_content_selector = "#preview-content-" + id;

        console.log(preview_content_selector);
        console.log(ajax_url);

        $.ajax({
          type: "POST",
          url: ajax_url,
          data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function(data){
            console.log(data)
            console.log(preview_content_selector);
            console.log(ajax_url);
            $(preview_content_selector).html(data);
          }
        });

      });

  });

</script>


{% endblock %}
